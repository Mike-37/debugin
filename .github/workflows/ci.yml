name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    name: Validate Multi-Runtime Build
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.9', '3.11', '3.13']
        node-version: ['18', '20']

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest requests

      - name: Install Node dependencies
        run: |
          cd tracepointdebug_final_library
          npm install
          cd ..

      - name: Run Python integration tests
        run: pytest tests/test_integration.py -v --tb=short

      - name: Run Python event sink tests
        run: pytest tests/test_event_sink_integration.py -v --tb=short || true

      - name: Run Python FT tests
        run: pytest tests/test_ft_runtime.py -v --tb=short || true

      - name: Build Java agent
        run: |
          cd agent-core
          mvn clean verify -DskipTests
          cd ..

      - name: Run Java tests
        run: |
          cd agent-core
          mvn test
          cd ..

      - name: Run Node.js tests
        run: node tests/test_node_integration.js || true

      - name: Run comprehensive validation
        run: python scripts/ci_validation.py

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run Bandit security scan
        run: bandit -r tracepointdebug -f json -o bandit-report.json || true

      - name: Check for known vulnerabilities
        run: safety check --json || true

  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install pylint flake8 black isort

      - name: Run flake8
        run: flake8 tracepointdebug tests --count --statistics || true

      - name: Run pylint
        run: pylint tracepointdebug --disable=all --enable=E --score=no || true

      - name: Check code formatting with black
        run: black --check tracepointdebug tests || true

  build-artifacts:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: [validate]

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Python package
        run: |
          pip install build
          python -m build

      - name: Build Java JAR
        run: |
          cd agent-core
          mvn clean package -DskipTests
          cd ..

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v3
        with:
          name: python-wheels
          path: dist/

      - name: Upload Java JAR
        uses: actions/upload-artifact@v3
        with:
          name: java-agent-jar
          path: agent-core/target/*.jar

  documentation:
    name: Documentation Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Validate documentation
        run: |
          # Check that all required documentation files exist
          test -f docs/control-plane-api.md
          test -f docs/event-schema.md
          test -f docs/PUBLIC_API.md
          test -f docs/PYTHON.md
          test -f docs/JAVA.md
          test -f docs/NODE.md
          test -f README.md
          test -f IMPLEMENTATION_STATUS.md
          echo "All documentation files present"

  status-report:
    name: Generate Status Report
    runs-on: ubuntu-latest
    if: always()
    needs: [validate, lint, security-scan, build-artifacts, documentation]

    steps:
      - uses: actions/checkout@v3

      - name: Print CI Status
        run: |
          echo "CI Pipeline Results:"
          echo "  Validation: ${{ needs.validate.result }}"
          echo "  Linting: ${{ needs.lint.result }}"
          echo "  Security: ${{ needs.security-scan.result }}"
          echo "  Build: ${{ needs.build-artifacts.result }}"
          echo "  Docs: ${{ needs.documentation.result }}"
